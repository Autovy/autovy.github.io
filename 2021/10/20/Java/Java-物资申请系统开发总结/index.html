<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/gear48.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/gear32.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="true"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"autovy.github.io","root":"/","scheme":"Gemini","version":"7.7.2","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="article">
<meta property="og:title" content="Java|物资申请系统开发总结">
<meta property="og:url" content="https://autovy.github.io/2021/10/20/Java/Java-%E7%89%A9%E8%B5%84%E7%94%B3%E8%AF%B7%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/index.html">
<meta property="og:site_name" content="Autovy&#39;s blog">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.githubusercontent.com/Autovy/Image/master/img/202205041947181.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Autovy/Image/master/img/202205041042079.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/Autovy/Image/master/img/202205041045668.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Autovy/Image/master/img/202205041053586.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Autovy/Image/master/img/202205041059831.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Autovy/Image/master/img/202205041102927.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Autovy/Image/master/img/202205041104629.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Autovy/Image/master/img/202203031543098.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Autovy/Image/master/img/202203031545235.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Autovy/Image/master/img/202203031646110.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Autovy/Image/master/img/202203031910440.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Autovy/Image/master/img/202203031939750.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Autovy/Image/master/img/202203111029709.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Autovy/Image/master/img/202203102017619.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Autovy/Image/master/img/202203102026158.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Autovy/Image/master/img/202203102031241.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Autovy/Image/master/img/202203102032065.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Autovy/Image/master/img/202203060908527.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Autovy/Image/master/img/202203060908268.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Autovy/Image/master/img/202202282106562.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Autovy/Image/master/img/202203060908527.png">
<meta property="og:image" content="https://raw.githubusercontent.com/Autovy/Image/master/img/202202282106562.png">
<meta property="article:published_time" content="2021-10-20T15:45:00.000Z">
<meta property="article:modified_time" content="2022-10-25T08:48:30.272Z">
<meta property="article:author" content="Autovy">
<meta property="article:tag" content="Java">
<meta property="article:tag" content="SpringBoot">
<meta property="article:tag" content="项目实战">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/Autovy/Image/master/img/202205041947181.png">

<link rel="canonical" href="https://autovy.github.io/2021/10/20/Java/Java-%E7%89%A9%E8%B5%84%E7%94%B3%E8%AF%B7%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true
  };
</script>

  <title>Java|物资申请系统开发总结 | Autovy's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Autovy's blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Autovy's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">Just For Interest</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">72</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">12</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">54</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="search-pop-overlay">
  <div class="popup search-popup">
      <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

  </div>
</div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://autovy.github.io/2021/10/20/Java/Java-%E7%89%A9%E8%B5%84%E7%94%B3%E8%AF%B7%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/2.png">
      <meta itemprop="name" content="Autovy">
      <meta itemprop="description" content="新时代农民工的数字农田">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Autovy's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Java|物资申请系统开发总结
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021/10/20 23:45:00" itemprop="dateCreated datePublished" datetime="2021-10-20T23:45:00+08:00">2021/10/20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Java/" itemprop="url" rel="index"><span itemprop="name">Java</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="热度" id="busuanzi_container_page_pv_test" style="display: inline;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">热度：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span>
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2021/10/20/Java/Java-%E7%89%A9%E8%B5%84%E7%94%B3%E8%AF%B7%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2021/10/20/Java/Java-%E7%89%A9%E8%B5%84%E7%94%B3%E8%AF%B7%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>38k</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p><img src="https://raw.githubusercontent.com/Autovy/Image/master/img/202205041947181.png" alt="image-20220504104541342"></p>
<span id="more"></span>

<h2 id="数据库架构"><a href="#数据库架构" class="headerlink" title="数据库架构"></a>数据库架构</h2><h3 id="数据库结构图"><a href="#数据库结构图" class="headerlink" title="数据库结构图"></a>数据库结构图</h3><p><img src="https://raw.githubusercontent.com/Autovy/Image/master/img/202205041042079.jpg" alt></p>
<h3 id="主要数据表信息"><a href="#主要数据表信息" class="headerlink" title="主要数据表信息"></a>主要数据表信息</h3><h4 id="一-物资申请表"><a href="#一-物资申请表" class="headerlink" title="一.物资申请表"></a>一.物资申请表</h4><p><img src="https://raw.githubusercontent.com/Autovy/Image/master/img/202205041045668.png" alt="image-20220504104541342"></p>
<ul>
<li>用户id : 物资申请条目 = 1 : n</li>
<li>机构id : 物资申请条目 = 1 : n</li>
</ul>
<h4 id="二-物资申请详情表"><a href="#二-物资申请详情表" class="headerlink" title="二.物资申请详情表"></a>二.物资申请详情表</h4><p><img src="https://raw.githubusercontent.com/Autovy/Image/master/img/202205041053586.png" alt="image-20220504105313339"></p>
<ul>
<li>物资申请条目id : 物资申请详情条目 = n : n</li>
<li>物资id : 物资申请详情条目 = n : n</li>
<li>(物资申请条目id,物资id) : 物资申请详情条目 = 1 : n</li>
</ul>
<h4 id="三-物资表"><a href="#三-物资表" class="headerlink" title="三.物资表"></a>三.物资表</h4><p><img src="https://raw.githubusercontent.com/Autovy/Image/master/img/202205041059831.png" alt="image-20220504105953610"></p>
<h4 id="四-用户表"><a href="#四-用户表" class="headerlink" title="四.用户表"></a>四.用户表</h4><p><img src="https://raw.githubusercontent.com/Autovy/Image/master/img/202205041102927.png" alt="image-20220504110242618"></p>
<ul>
<li>用户信息条目 : 权限id = 1 : 1</li>
</ul>
<h4 id="五-权限表"><a href="#五-权限表" class="headerlink" title="五.权限表"></a>五.权限表</h4><p><img src="https://raw.githubusercontent.com/Autovy/Image/master/img/202205041104629.png" alt="image-20220504110408506"></p>
<h2 id="系统架构"><a href="#系统架构" class="headerlink" title="系统架构"></a>系统架构</h2><h3 id="技术架构"><a href="#技术架构" class="headerlink" title="技术架构"></a>技术架构</h3><h4 id="一-前端"><a href="#一-前端" class="headerlink" title="一.前端"></a>一.前端</h4><ul>
<li>Vue.js：前端逻辑处理数据</li>
<li>Bootstrap：使用模板样式</li>
<li>Jquery</li>
<li>axios</li>
<li>Thymeleaf：主要使用其HTML包含技术，整合页面共用部分（Springboot官方推荐的视图）</li>
</ul>
<h4 id="二-后端"><a href="#二-后端" class="headerlink" title="二.后端"></a>二.后端</h4><ul>
<li>SpringBoot 1.5.9 RELEASE</li>
<li>Shiro安全框架</li>
<li>Maven</li>
<li>Hibernate</li>
<li>Elasticsearch搜索引擎</li>
</ul>
<h4 id="三-数据库"><a href="#三-数据库" class="headerlink" title="三.数据库"></a>三.数据库</h4><ul>
<li>MySQL数据库</li>
<li>Redis</li>
</ul>
<h3 id="相关依赖准备"><a href="#相关依赖准备" class="headerlink" title="相关依赖准备"></a>相关依赖准备</h3><p>pom.xml文件导入相关依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- springboot web --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- springboot tomcat 支持 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 热部署 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- jpa：java持久层api，用于操作数据库--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- redis：基于内存、分布式、可选持久性的键值对(Key-Value)存储数据库，一般说来，会被当作缓存使用。 因为它比数据库(mysql)快 --&gt;</span>      </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>   </span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- springboot test --&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span> </span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- thymeleaf： Thymeleaf 是一种模板语言，可以达到和JSP一样的效果，但是比起JSP 对于前端测试更加友好--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- elastic search：Elasticsearch是一个基于Lucene库的搜索引擎。它提供了一个分布式、支持多租户的全文搜索引擎 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 用了 elasticsearch 就要加这么一个，不然要com.sun.jna.Native 错误 --&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.sun.jna<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jna<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.9<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>        </span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- thymeleaf legacyhtml5 模式支持 --&gt;</span>      </span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>net.sourceforge.nekohtml<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>nekohtml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>   </span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 测试支持 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span> </span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- tomcat的支持.--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.embed<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-embed-jasper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.5.23<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- mysql：数据库支持--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.21<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- junit：java自动测试工具 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span> 4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- commons-lang：提供常用工具包 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-lang<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>       </span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- shiro：Java 当下常见的安全框架，主要用于用户验证和授权操作 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.shiro<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>shiro-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span>  </span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- hsqldb是一款Java内置的数据库，非常适合在用于快速的测试和演示的Java程序中 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hsqldb<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hsqldb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- springfox-swagger依赖添加：文档化工具 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.guava<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>guava<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>20.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-swagger2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.9.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.xiaoymin<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>swagger-bootstrap-ui<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.9.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>







<h2 id="开发内容"><a href="#开发内容" class="headerlink" title="开发内容"></a>开发内容</h2><h3 id="MySQL优化过程"><a href="#MySQL优化过程" class="headerlink" title="MySQL优化过程"></a>MySQL优化过程</h3><h4 id="一-T-SQL脚本分表优化"><a href="#一-T-SQL脚本分表优化" class="headerlink" title="一.T-SQL脚本分表优化"></a>一.T-SQL脚本分表优化</h4><h5 id="1-相关表的结构"><a href="#1-相关表的结构" class="headerlink" title="1.相关表的结构"></a>1.相关表的结构</h5><p>此处展示的表结构为维护前</p>
<p>物资申请表：共4817条数据</p>
<p><img src="https://raw.githubusercontent.com/Autovy/Image/master/img/202203031543098.png" alt="image-20220303154338625"></p>
<p>物资信息表：</p>
<p><img src="https://raw.githubusercontent.com/Autovy/Image/master/img/202203031545235.png" alt="image-20220303154513022"></p>
<p>goods_count：当前仓库物品数（物理的）</p>
<p>good_leftCount：当前物品可借数（网络的：存在部分未借出，但已被预订仍在审核中的物品）</p>
<h5 id="2-优化思路：物资申请表分表"><a href="#2-优化思路：物资申请表分表" class="headerlink" title="2.优化思路：物资申请表分表"></a>2.优化思路：物资申请表分表</h5><p>从上面的tw_apply表就可以知道：</p>
<ul>
<li><p>在用户提出申请后，物资申请信息被后端拼成了一个字符串存储在apply_content（同时利用了前端的数据执行了物品可借数的预扣除，所以这部分没有用到物资申请信息字符串的解析）</p>
</li>
<li><p>通过审核后，物品正式借出，这时候只留有物资申请信息的字符串存储在数据库，所以需要后端对该字符串解析提取出申请物资与其借用数量，再去操作数据库</p>
</li>
</ul>
<p>还好后端大哥没有把物资申请信息的字符串直接发给前端，我真的哭死，设计数据库的那个出来挨打（前端不需要解析，但是要拼接展示字符串）</p>
<p>数据库设计十分不合理，甚至不符合第一范式，<strong>浪费数据库大量存储空间</strong>不说，而且后端拼接字符串解析字符串这一过程<strong>十分耗时且占用内存</strong>，而且最新的需求是需要增加一个审核过程申请物资调整功能</p>
<p>所以我将物资申请表进行分表（水平分表），分出物资申请详情表并联系物资信息表，其结构如下</p>
<p><img src="https://raw.githubusercontent.com/Autovy/Image/master/img/202203031646110.png" alt="image-20220303164602406"></p>
<p>删除掉apply_content字段，节省数据库空间</p>
<p>分表后，通过tw_applydetail表，我们对物资申请信息的所以内容进行操作，省去了物资审核接口对字符串解析的耗时过程并且方便审核过程申请物资调整功能的开发（通过tw_appdetail找到物品信息和物品数量）</p>
<h5 id="3-优化操作：存储过程脚本"><a href="#3-优化操作：存储过程脚本" class="headerlink" title="3.优化操作：存储过程脚本"></a>3.优化操作：存储过程脚本</h5><p>存储过程（Stored Procedure）是一种在数据库中存储复杂程序，以便外部程序调用的一种数据库对象</p>
<p>这里值得注意的是在遍历游标的循环中，如果查询不存在或为空会跳出循环</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> DEFINER<span class="operator">=</span>`Autovy`@`localhost` <span class="keyword">PROCEDURE</span> `demo`()</span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line">		</span><br><span class="line"> <span class="comment">-- 定义变量</span></span><br><span class="line"><span class="keyword">DECLARE</span> i <span class="type">INT</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">DECLARE</span> s <span class="type">int</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">DECLARE</span> n TINYTEXT;</span><br><span class="line"><span class="keyword">DECLARE</span> m <span class="type">INT</span>(<span class="number">11</span>);</span><br><span class="line"> # 求分割符号<span class="string">&#x27;,&#x27;</span>的位置</span><br><span class="line"><span class="keyword">DECLARE</span> _index <span class="type">INT</span>;</span><br><span class="line"></span><br><span class="line"># 单个物品申请信息</span><br><span class="line"><span class="keyword">DECLARE</span> str TINYTEXT;</span><br><span class="line"></span><br><span class="line"># 单个物品申请信息长度</span><br><span class="line"><span class="keyword">DECLARE</span> strLength <span class="type">int</span>;</span><br><span class="line"></span><br><span class="line"># 物品名称</span><br><span class="line"><span class="keyword">DECLARE</span> goodName <span class="type">VARCHAR</span>(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"># 物品数量</span><br><span class="line"><span class="keyword">DECLARE</span> goodCount <span class="type">int</span>(<span class="number">11</span>);</span><br><span class="line"></span><br><span class="line"># 物品id</span><br><span class="line"><span class="keyword">DECLARE</span> goodId <span class="type">int</span>(<span class="number">11</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 定义游标，并将sql结果集赋值给游标</span></span><br><span class="line"><span class="keyword">DECLARE</span> apply_id1 <span class="keyword">CURSOR</span> <span class="keyword">FOR</span> <span class="keyword">SELECT</span> id, apply_content <span class="keyword">FROM</span> tw_apply <span class="keyword">WHERE</span> apply_content <span class="keyword">LIKE</span> &quot;本部%&quot;;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 声明当游标遍历完后将标志变量置成1</span></span><br><span class="line"><span class="keyword">DECLARE</span> CONTINUE HANDLER <span class="keyword">FOR</span> <span class="keyword">NOT</span> FOUND <span class="keyword">SET</span> s<span class="operator">=</span><span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 打开游标</span></span><br><span class="line"><span class="keyword">OPEN</span> apply_id1;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 将游标中的值赋值给变量，注意：变量名不要和返回列名同名，变量顺序要和sql结果顺序一致</span></span><br><span class="line"><span class="keyword">FETCH</span> apply_id1 <span class="keyword">into</span> m, n;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 当s != 1,一直循环</span></span><br><span class="line">while s<span class="operator">&lt;&gt;</span><span class="number">1</span> do</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">SET</span> _index <span class="operator">=</span> LOCATE(<span class="string">&#x27;;&#x27;</span>, n);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">-- 通过;分割单个物品的申请信息：北院—帐篷物品1个;北院—椅子物品1个;北院—桌子物品1个;</span></span><br><span class="line">	while _index <span class="operator">&gt;</span> <span class="number">0</span>  do</span><br><span class="line">		</span><br><span class="line">		<span class="comment">-- 拿到单个物品申请信息：本部——桌子物品1个</span></span><br><span class="line">		<span class="keyword">SET</span> str <span class="operator">=</span> <span class="keyword">LEFT</span>(n, _index<span class="number">-1</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">SET</span> strLength <span class="operator">=</span> LENGTH(str) <span class="operator">/</span> <span class="number">5</span>;</span><br><span class="line">	</span><br><span class="line">		<span class="comment">-- 拿到物品名称</span></span><br><span class="line">		<span class="keyword">SET</span> goodName <span class="operator">=</span> <span class="keyword">LEFT</span>(str, strLength);</span><br><span class="line">		</span><br><span class="line">		<span class="comment">-- 拿到物品个数(类型转换为整数)</span></span><br><span class="line">		<span class="keyword">SET</span> goodCount <span class="operator">=</span> <span class="built_in">CAST</span>(<span class="keyword">LEFT</span>(<span class="keyword">RIGHT</span>(str, <span class="number">2</span>), <span class="number">1</span>) <span class="keyword">AS</span> signed) ;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">SELECT</span> goodName;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">-- 按物品名称查到物品id并存储到goodId中</span></span><br><span class="line">		<span class="comment">-- 这里如果查询不存在或为空会跳出游标循环，值得注意</span></span><br><span class="line">		<span class="keyword">SELECT</span> goods_id <span class="keyword">into</span> goodId <span class="keyword">FROM</span> tw_goods <span class="keyword">WHERE</span> goods_show <span class="keyword">LIKE</span> goodName <span class="keyword">ORDER</span> <span class="keyword">BY</span> goods_count <span class="keyword">DESC</span> LIMIT <span class="number">1</span>;</span><br><span class="line">			</span><br><span class="line">		<span class="comment">-- 插入数据</span></span><br><span class="line">		<span class="keyword">INSERT</span> tw_applydetail(apply_id, good_id, count) <span class="keyword">VALUES</span> (m, goodId, goodCount);</span><br><span class="line">			</span><br><span class="line">		<span class="comment">-- 移动到下个分界点</span></span><br><span class="line">		<span class="keyword">SET</span> n <span class="operator">=</span> SUBSTR(n <span class="keyword">FROM</span> _index<span class="operator">+</span><span class="number">1</span>);</span><br><span class="line">		<span class="keyword">SET</span> _index <span class="operator">=</span> LOCATE(<span class="string">&#x27;;&#x27;</span>, n);</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">end</span> while;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">-- 执行业务逻辑</span></span><br><span class="line">	<span class="keyword">set</span> i <span class="operator">=</span> i<span class="operator">+</span><span class="number">1</span>;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 读取下一条数据，读取完成置变量s=1</span></span><br><span class="line"><span class="keyword">FETCH</span> apply_id1 <span class="keyword">into</span> m, n;</span><br><span class="line"><span class="keyword">end</span> while;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 关闭游标</span></span><br><span class="line"><span class="keyword">close</span> apply_id1;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure>

<p>当时经过一天的对存储过程的学习，我总结出了以下经验：存储过程非常不方便调试，而且报错信息只定位不报错误类型（sql是这样的）。如果能重来，对数据库的批量操作，首选Python或Shell</p>
<h5 id="4-优化结果"><a href="#4-优化结果" class="headerlink" title="4.优化结果"></a>4.优化结果</h5><ul>
<li>截至目前物资申请表已有4817条数据，考虑到后面数据会长期积累，这样的优化是有必要的</li>
<li>去掉后端耗时耗内存的字符串解析工作</li>
<li>节省数据库存储空间，优化前申请表内存占0.79MB，优化后占0.56MB</li>
</ul>
<p>另外附加一个容量查询小工具，可查询数据库各表容量大小</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">select</span><br><span class="line">table_schema as &#39;数据库&#39;,</span><br><span class="line">table_name as &#39;表名&#39;,</span><br><span class="line">table_rows as &#39;记录数&#39;,</span><br><span class="line">truncate(data_length&#x2F;1024&#x2F;1024, 2) as &#39;数据容量(MB)&#39;,</span><br><span class="line">truncate(index_length&#x2F;1024&#x2F;1024, 2) as &#39;索引容量(MB)&#39;</span><br><span class="line">from information_schema.tables</span><br><span class="line">where table_schema&#x3D;&#39;bgs&#39;</span><br><span class="line">order by data_length desc, index_length desc;</span><br></pre></td></tr></table></figure>



<h4 id="二-索引优化查询"><a href="#二-索引优化查询" class="headerlink" title="二.索引优化查询"></a>二.索引优化查询</h4><h5 id="1-相关表结构"><a href="#1-相关表结构" class="headerlink" title="1.相关表结构"></a>1.相关表结构</h5><p>日志记录表：共33687条数据</p>
<p><img src="https://raw.githubusercontent.com/Autovy/Image/master/img/202203031910440.png" alt="image-20220303191047146"></p>
<h5 id="2-优化思路：添加索引"><a href="#2-优化思路：添加索引" class="headerlink" title="2.优化思路：添加索引"></a>2.优化思路：添加索引</h5><p>关于索引的知识点这里不细说，推荐阅读：<a target="_blank" rel="noopener" href="https://javaguide.cn/database/mysql/mysql-index/">MySQL 索引详解</a></p>
<p>由于日志表数据庞大，有3万条数据，为了达到快速通过用户名模糊查找到日志操作内容和操作时间，就需要用到索引，另外在模糊查询中，<strong>like语句要使索引生效，like后不能以%开始，也就是说 （like %字段名%） 、（like %字段名）这类语句会使索引失效，而（like 字段名）、（like 字段名%）这类语句索引是可以正常使用</strong></p>
<p>所以我将查询的模糊匹配由“%xxxx%”改为“xxxx%”，只模糊匹配前面部分</p>
<h5 id="3-优化操作"><a href="#3-优化操作" class="headerlink" title="3.优化操作"></a>3.优化操作</h5><p>这里直接使用Navicat可视化添加索引，因为后台查询日志是需要用用户名模糊查找到日志操作内容和操作时间，所以需要添加的索引为log_realnam</p>
<p><img src="https://raw.githubusercontent.com/Autovy/Image/master/img/202203031939750.png" alt="image-20220303193939350"></p>
<p>更改mybatis的sql映射，解决sql注入和索引失效问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT log_realname, log_content, log_time FROM tw_log WHERE log_realname LIKE &quot;%$&#123;log_name&#125;%&quot;;  </span><br></pre></td></tr></table></figure>



<p>在这种情况下使用#程序会报错，新手程序员就把#号改成了$,这样如果java代码层面没有对用户输入的内容做处理势必会产生SQL注入漏洞。</p>
<p>正确写法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT log_realname, log_content, log_time FROM tw_log WHERE log_realname LIKE concat(‘%’,#&#123;log_name&#125;, ‘%’) </span><br></pre></td></tr></table></figure>

<h5 id="4-优化结果-1"><a href="#4-优化结果-1" class="headerlink" title="4.优化结果"></a>4.优化结果</h5><ul>
<li>添加索引前使用用户名模糊查询日志，耗时大约0.045s，添加索引后耗时大约0.032s，减少了磁盘IO，提高了查询速度</li>
<li>修改mybatis中模糊查询的sql语句，解决索引失效的问题，并解决了模糊查询中拼接字符串的sql注入问题</li>
</ul>
<h3 id="Elasticsearch搜索"><a href="#Elasticsearch搜索" class="headerlink" title="Elasticsearch搜索"></a>Elasticsearch搜索</h3><h4 id="一-ES配置"><a href="#一-ES配置" class="headerlink" title="一.ES配置"></a>一.ES配置</h4><h5 id="1-ES可视化"><a href="#1-ES可视化" class="headerlink" title="1.ES可视化"></a>1.ES可视化</h5><p>kibana是es的可视化工具，开启后可以通过访问 <a target="_blank" rel="noopener" href="http://127.0.0.1:5601/">http://127.0.0.1:5601/</a>  查看kibana页面</p>
<p><img src="https://raw.githubusercontent.com/Autovy/Image/master/img/202203111029709.png" alt="image-20220311102937485"></p>
<h5 id="2-配置ES"><a href="#2-配置ES" class="headerlink" title="2.配置ES"></a>2.配置ES</h5><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ElasticSearch</span></span><br><span class="line"><span class="meta">spring.data.elasticsearch.cluster-nodes</span> = <span class="string">127.0.0.1:9300</span></span><br></pre></td></tr></table></figure>



<h4 id="二-ES开发流程"><a href="#二-ES开发流程" class="headerlink" title="二.ES开发流程"></a>二.ES开发流程</h4><h5 id="1-ES注解实体类"><a href="#1-ES注解实体类" class="headerlink" title="1.ES注解实体类"></a>1.ES注解实体类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @Document注解Category实体类，一个Category对象即为一个Document（相当于数据库的一行）</span></span><br><span class="line"><span class="comment">// 连接到es的tmall_springboot索引（相当于数据库），produt类（相当于表）上</span></span><br><span class="line"><span class="meta">@Document(indexName = &quot;tmall_springboot&quot;,type = &quot;product&quot;)</span></span><br></pre></td></tr></table></figure>



<h5 id="2-esDAO的创建"><a href="#2-esDAO的创建" class="headerlink" title="2.esDAO的创建"></a>2.esDAO的创建</h5><p>由于整合了ES的JPA和操作数据库使用的JPA有冲突，所以不能放在同一个包下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.how2java.tmall.es;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.data.elasticsearch.repository.ElasticsearchRepository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.how2java.tmall.pojo.Product;</span><br><span class="line"><span class="comment">// 用于链接es的DAO</span></span><br><span class="line"><span class="comment">// esDAO和其他DAO不能放在一个包下否则会启动异常</span></span><br><span class="line"><span class="comment">// 主要使用es实现对产品的模糊查询</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProductESDAO</span> <span class="keyword">extends</span> <span class="title">ElasticsearchRepository</span>&lt;<span class="title">Product</span>,<span class="title">Integer</span>&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h5 id="3-Application引入ES"><a href="#3-Application引入ES" class="headerlink" title="3.Application引入ES"></a>3.Application引入ES</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// esJPA引入</span></span><br><span class="line"><span class="meta">@EnableElasticsearchRepositories(basePackages = &quot;com.how2java.tmall.es&quot;)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// JPA引入</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories(basePackages = &#123;&quot;com.how2java.tmall.dao&quot;, &quot;com.how2java.tmall.pojo&quot;&#125;)</span></span><br></pre></td></tr></table></figure>





<h5 id="4-服务层同步ES"><a href="#4-服务层同步ES" class="headerlink" title="4.服务层同步ES"></a>4.服务层同步ES</h5><p><strong>增删改操作</strong></p>
<p>增删改操作的数据需要同步ES和数据库</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过ProductDAO对数据库有影响的</span></span><br><span class="line"><span class="comment">// 都要通过productESDAO同步到es</span></span><br><span class="line"><span class="meta">@CacheEvict(allEntries=true)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Product bean)</span> </span>&#123;</span><br><span class="line">	productDAO.save(bean);</span><br><span class="line">	productESDAO.save(bean);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@CacheEvict(allEntries=true)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">	productDAO.delete(id);</span><br><span class="line">	productESDAO.delete(id);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@CacheEvict(allEntries=true)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(Product bean)</span> </span>&#123;</span><br><span class="line">	productDAO.save(bean);</span><br><span class="line">	productESDAO.save(bean);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>ES初始化</strong></p>
<p>ES内数据为空，就将数据库中的数据同步到es</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化数据到es</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initDatabase2ES</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	Pageable pageable = <span class="keyword">new</span> PageRequest(<span class="number">0</span>, <span class="number">5</span>);</span><br><span class="line">	Page&lt;Product&gt; page =productESDAO.findAll(pageable);</span><br><span class="line">	<span class="comment">// 查询es中是否有数据</span></span><br><span class="line">	<span class="keyword">if</span>(page.getContent().isEmpty()) &#123;</span><br><span class="line">		<span class="comment">// 如果数据为空，将数据从数据库同步到es中</span></span><br><span class="line">		List&lt;Product&gt; products= productDAO.findAll();</span><br><span class="line">		<span class="keyword">for</span> (Product product : products) &#123;</span><br><span class="line">			productESDAO.save(product);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="5-服务层查询ES"><a href="#5-服务层查询ES" class="headerlink" title="5.服务层查询ES"></a>5.服务层查询ES</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 通过es进行查询</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Product&gt; <span class="title">search</span><span class="params">(String keyword, <span class="keyword">int</span> start, <span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 初始化es</span></span><br><span class="line">	initDatabase2ES();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// QueryBuilders提供了大量静态方法，用于生成各种不同类型的查询对象</span></span><br><span class="line">	<span class="comment">// 构建查询条件（多条件查询）</span></span><br><span class="line">	FunctionScoreQueryBuilder functionScoreQueryBuilder = QueryBuilders.functionScoreQuery()</span><br><span class="line">			<span class="comment">// 为提供的字段名和文本创建一个通用查询</span></span><br><span class="line">			.add(QueryBuilders.matchPhraseQuery(<span class="string">&quot;name&quot;</span>, keyword),</span><br><span class="line">					ScoreFunctionBuilders.weightFactorFunction(<span class="number">100</span>))</span><br><span class="line">			<span class="comment">// 设置权重分为求和模式</span></span><br><span class="line">			.scoreMode(<span class="string">&quot;sum&quot;</span>)</span><br><span class="line">			<span class="comment">// 设置权重分最低分</span></span><br><span class="line">			.setMinScore(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 设置分页参数</span></span><br><span class="line">	Sort sort  = <span class="keyword">new</span> Sort(Sort.Direction.DESC,<span class="string">&quot;id&quot;</span>);</span><br><span class="line">	Pageable pageable = <span class="keyword">new</span> PageRequest(start, size,sort);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 添加分页参数和查询条件</span></span><br><span class="line">	SearchQuery searchQuery = <span class="keyword">new</span> NativeSearchQueryBuilder()</span><br><span class="line">			.withPageable(pageable)</span><br><span class="line">			.withQuery(functionScoreQueryBuilder).build();</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 执行查询获取结果</span></span><br><span class="line">	Page&lt;Product&gt; page = productESDAO.search(searchQuery);</span><br><span class="line">	<span class="comment">// 返回结果</span></span><br><span class="line">	<span class="keyword">return</span> page.getContent();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Redis缓存"><a href="#Redis缓存" class="headerlink" title="Redis缓存"></a>Redis缓存</h3><h4 id="一-Redis可视化工具"><a href="#一-Redis可视化工具" class="headerlink" title="一.Redis可视化工具"></a>一.Redis可视化工具</h4><p>推荐使用RedisClient，数据一般都在db0中</p>
<p><img src="https://raw.githubusercontent.com/Autovy/Image/master/img/202203102017619.png" alt="image-20220310201748019"></p>
<h4 id="二-Redis配置"><a href="#二-Redis配置" class="headerlink" title="二.Redis配置"></a>二.Redis配置</h4><h5 id="1-Redis配置类"><a href="#1-Redis配置类" class="headerlink" title="1.Redis配置类"></a>1.Redis配置类</h5><p>该缓存配置类主要是使redis内的key和value转换为可读性的字符串</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">//Redis 缓存配置类</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RedisConfig</span> <span class="keyword">extends</span> <span class="title">CachingConfigurerSupport</span> </span>&#123; </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CacheManager <span class="title">cacheManager</span><span class="params">(RedisTemplate&lt;?,?&gt; redisTemplate)</span> </span>&#123;</span><br><span class="line">        RedisSerializer stringSerializer = <span class="keyword">new</span> StringRedisSerializer();</span><br><span class="line">        Jackson2JsonRedisSerializer jackson2JsonRedisSerializer = <span class="keyword">new</span> Jackson2JsonRedisSerializer(Object.class);</span><br><span class="line">        ObjectMapper om = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">        om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.PUBLIC_ONLY);</span><br><span class="line">        om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);</span><br><span class="line">        jackson2JsonRedisSerializer.setObjectMapper(om);</span><br><span class="line">        redisTemplate.setKeySerializer(stringSerializer);</span><br><span class="line">        redisTemplate.setHashKeySerializer(stringSerializer);  </span><br><span class="line">         </span><br><span class="line">        redisTemplate.setValueSerializer(jackson2JsonRedisSerializer);         </span><br><span class="line">        redisTemplate.setHashValueSerializer(jackson2JsonRedisSerializer);</span><br><span class="line">        CacheManager cacheManager = <span class="keyword">new</span> RedisCacheManager(redisTemplate);</span><br><span class="line">        <span class="keyword">return</span> cacheManager;</span><br><span class="line">  </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h5 id="2-Redis配置文件"><a href="#2-Redis配置文件" class="headerlink" title="2.Redis配置文件"></a>2.Redis配置文件</h5><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Redis数据库索引（默认为0）</span></span><br><span class="line"><span class="meta">spring.redis.database</span>=<span class="string">0</span></span><br><span class="line"><span class="comment"># Redis服务器地址</span></span><br><span class="line"><span class="meta">spring.redis.host</span>=<span class="string">127.0.0.1</span></span><br><span class="line"><span class="comment"># Redis服务器连接端口</span></span><br><span class="line"><span class="meta">spring.redis.port</span>=<span class="string">6379</span></span><br><span class="line"><span class="comment"># Redis服务器连接密码（默认为空）</span></span><br><span class="line"><span class="meta">spring.redis.password</span>=<span class="string"></span></span><br><span class="line"><span class="comment"># 连接池最大连接数（使用负值表示没有限制）</span></span><br><span class="line"><span class="meta">spring.redis.pool.max-active</span>=<span class="string">10</span></span><br><span class="line"><span class="comment"># 连接池最大阻塞等待时间（使用负值表示没有限制）</span></span><br><span class="line"><span class="meta">spring.redis.pool.max-wait</span>=<span class="string">-1</span></span><br><span class="line"><span class="comment"># 连接池中的最大空闲连接</span></span><br><span class="line"><span class="meta">spring.redis.pool.max-idle</span>=<span class="string">8</span></span><br><span class="line"><span class="comment"># 连接池中的最小空闲连接</span></span><br><span class="line"><span class="meta">spring.redis.pool.min-idle</span>=<span class="string">0</span></span><br><span class="line"><span class="comment"># 连接超时时间（毫秒）</span></span><br><span class="line"><span class="meta">spring.redis.timeout</span>=<span class="string">0</span></span><br></pre></td></tr></table></figure>



<h4 id="三-缓存启用与检测"><a href="#三-缓存启用与检测" class="headerlink" title="三.缓存启用与检测"></a>三.缓存启用与检测</h4><h5 id="1-缓存的启用"><a href="#1-缓存的启用" class="headerlink" title="1.缓存的启用"></a>1.缓存的启用</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 系统启动入口</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="comment">// 启动缓存</span></span><br><span class="line"><span class="meta">@EnableCaching</span></span><br><span class="line"><span class="meta">@EnableElasticsearchRepositories(basePackages = &quot;com.how2java.tmall.es&quot;)</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories(basePackages = &#123;&quot;com.how2java.tmall.dao&quot;, &quot;com.how2java.tmall.pojo&quot;&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="comment">// 检测端口上的服务是否启动</span></span><br><span class="line">        PortUtil.checkPort(<span class="number">6379</span>,<span class="string">&quot;Redis 服务端&quot;</span>,<span class="keyword">true</span>);</span><br><span class="line">        PortUtil.checkPort(<span class="number">9300</span>,<span class="string">&quot;ElasticSearch 服务端&quot;</span>,<span class="keyword">true</span>);</span><br><span class="line">        PortUtil.checkPort(<span class="number">5601</span>,<span class="string">&quot;Kibana 工具&quot;</span>, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(Application.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="2-服务开启检测"><a href="#2-服务开启检测" class="headerlink" title="2.服务开启检测"></a>2.服务开启检测</h5><p>这里的PortUtil是一个检测端口上服务是否运行的简单工具类，如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">package</span> com.how2java.tmall.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.ServerSocket;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.swing.JOptionPane;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 工具类，检查某个端口对应的服务是否启动</span></span><br><span class="line"><span class="comment">// 可以用于检查redis服务和es服务</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PortUtil</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">testPort</span><span class="params">(<span class="keyword">int</span> port)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			ServerSocket ss = <span class="keyword">new</span> ServerSocket(port);</span><br><span class="line">			ss.close();</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (java.net.BindException e) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">		&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">checkPort</span><span class="params">(<span class="keyword">int</span> port, String server, <span class="keyword">boolean</span> shutdown)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">if</span>(!testPort(port)) &#123;</span><br><span class="line">			<span class="keyword">if</span>(shutdown) &#123;</span><br><span class="line">				String message =String.format(<span class="string">&quot;在端口 %d 未检查得到 %s 启动%n&quot;</span>,port,server);</span><br><span class="line">				JOptionPane.showMessageDialog(<span class="keyword">null</span>, message);</span><br><span class="line">				System.exit(<span class="number">1</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span> &#123;</span><br><span class="line">				String message =String.format(<span class="string">&quot;在端口 %d 未检查得到 %s 启动%n,是否继续?&quot;</span>,port,server);</span><br><span class="line">			    <span class="keyword">if</span>(JOptionPane.OK_OPTION != 	JOptionPane.showConfirmDialog(<span class="keyword">null</span>, message)) </span><br><span class="line">					System.exit(<span class="number">1</span>);</span><br><span class="line">			    </span><br><span class="line">				</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="四-缓存的使用"><a href="#四-缓存的使用" class="headerlink" title="四.缓存的使用"></a>四.缓存的使用</h4><p>缓存的使用一般在服务层使用</p>
<h5 id="1-有序集合管理"><a href="#1-有序集合管理" class="headerlink" title="1.有序集合管理"></a>1.有序集合管理</h5><p>通过在服务层中注解@CacheConfig，创建一个有序集合类型的缓存，管理该服务下所有的keys</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 分类服务层</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="comment">// redis缓存一般都在服务层进行操作</span></span><br><span class="line"><span class="comment">// 分类服务下的所有keys都由categories来管理（数据存储与categories是平行关系）</span></span><br><span class="line"><span class="meta">@CacheConfig(cacheNames=&quot;categories&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CategoryService</span> </span>&#123;</span><br><span class="line">	.....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://raw.githubusercontent.com/Autovy/Image/master/img/202203102026158.png" alt="image-20220310202613389"></p>
<h5 id="2查询插入缓存"><a href="#2查询插入缓存" class="headerlink" title="2查询插入缓存"></a>2查询插入缓存</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获得单条分类服务</span></span><br><span class="line"><span class="comment">// 添加一条缓存到redis中，以categories-one- + 参数id为key值</span></span><br><span class="line"><span class="comment">// 存储的主要数据为Category对象</span></span><br><span class="line"><span class="meta">@Cacheable(key=&quot;&#x27;categories-one-&#x27;+ #p0&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Category <span class="title">get</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">	Category c= categoryDAO.findOne(id);</span><br><span class="line">	<span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 列出单页分类表（提供分页组索引）</span></span><br><span class="line"><span class="comment">// 添加一条缓存到redis中，以categories-page- + 参数start + 参数size 为key值</span></span><br><span class="line"><span class="comment">// 存储的主要数据为Page4Navigator&lt;Category&gt;数组</span></span><br><span class="line"><span class="meta">@Cacheable(key=&quot;&#x27;categories-page-&#x27;+#p0+ &#x27;-&#x27; + #p1&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Page4Navigator&lt;Category&gt; <span class="title">list</span><span class="params">(<span class="keyword">int</span> start, <span class="keyword">int</span> size, <span class="keyword">int</span> navigatePages)</span> </span>&#123;</span><br><span class="line">   	Sort sort = <span class="keyword">new</span> Sort(Sort.Direction.DESC, <span class="string">&quot;id&quot;</span>);</span><br><span class="line">	Pageable pageable = <span class="keyword">new</span> PageRequest(start, size, sort);</span><br><span class="line">	Page pageFromJPA =categoryDAO.findAll(pageable);</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> Page4Navigator&lt;&gt;(pageFromJPA,navigatePages);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>返回的java对象或集合都会变成JSON字符串</p>
<p><img src="https://raw.githubusercontent.com/Autovy/Image/master/img/202203102031241.png" alt="image-20220310203123882"></p>
<p><img src="https://raw.githubusercontent.com/Autovy/Image/master/img/202203102032065.png" alt="image-20220310203207786"></p>
<h5 id="3-更新删除缓存"><a href="#3-更新删除缓存" class="headerlink" title="3.更新删除缓存"></a>3.更新删除缓存</h5><p>准确来说是插入，删除，更新删除缓存以保持数据一致性</p>
<p>使用@CacheEvict(allEntries=true)删除category~keys的所有keys</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 增加删除更新时</span></span><br><span class="line"><span class="comment">// 增加分类服务</span></span><br><span class="line"><span class="meta">@CacheEvict(allEntries=true)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(Category bean)</span> </span>&#123;</span><br><span class="line">	categoryDAO.save(bean);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 删除分类服务</span></span><br><span class="line"><span class="meta">@CacheEvict(allEntries=true)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delete</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">	categoryDAO.delete(id);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 更新分类服务</span></span><br><span class="line"><span class="meta">@CacheEvict(allEntries=true)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">update</span><span class="params">(Category bean)</span> </span>&#123;</span><br><span class="line">	categoryDAO.save(bean);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Shiro登录验证"><a href="#Shiro登录验证" class="headerlink" title="Shiro登录验证"></a>Shiro登录验证</h3><p>由于本项目仅仅有用户一个权限，所以只需要判断用户是否登录，并不需要比较细粒度的权限分配</p>
<h4 id="一-JPARealm验证授权器"><a href="#一-JPARealm验证授权器" class="headerlink" title="一.JPARealm验证授权器"></a>一.JPARealm验证授权器</h4><p>Shiro与用户之间的中介，为Shiro提供验证和授权用户的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.how2java.tmall.realm;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationException;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.AuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.SimpleAuthenticationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.AuthorizationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authz.SimpleAuthorizationInfo;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.realm.AuthorizingRealm;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.PrincipalCollection;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.ByteSource;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.how2java.tmall.pojo.User;</span><br><span class="line"><span class="keyword">import</span> com.how2java.tmall.service.UserService;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过JPA进行验证授权</span></span><br><span class="line"><span class="comment">// （相当于一个中介，拿着用户信息去数据库找用户拥有的角色和权限）</span></span><br><span class="line"><span class="comment">// 将Realm提供给Shiro，由其负责调用，不需要直接调用</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JPARealm</span> <span class="keyword">extends</span> <span class="title">AuthorizingRealm</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 认证：查询用户身份与密码，解决你是谁的问题</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> AuthenticationInfo <span class="title">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">		<span class="comment">// 从token中取出用户名称</span></span><br><span class="line">		String userName = token.getPrincipal().toString();</span><br><span class="line">		<span class="comment">// 查询用户表得到用户加密密码</span></span><br><span class="line">		User user = userService.getByName(userName);</span><br><span class="line">		String passwordInDB = user.getPassword();</span><br><span class="line">		<span class="comment">// 获得用户表中的盐</span></span><br><span class="line">		String salt = user.getSalt();</span><br><span class="line">		<span class="comment">// 以用户名，加密密码，盐，真实信息，真正姓名作为认证信息</span></span><br><span class="line">		SimpleAuthenticationInfo authenticationInfo = <span class="keyword">new</span> SimpleAuthenticationInfo(userName, passwordInDB, ByteSource.Util.bytes(salt),</span><br><span class="line">				getName());</span><br><span class="line">		<span class="keyword">return</span> authenticationInfo;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="comment">// 授权：赋予用户权限，解决你能做什么的问题</span></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> AuthorizationInfo <span class="title">doGetAuthorizationInfo</span><span class="params">(PrincipalCollection principalCollection)</span> </span>&#123;</span><br><span class="line">		<span class="comment">//</span></span><br><span class="line">		SimpleAuthorizationInfo s = <span class="keyword">new</span> SimpleAuthorizationInfo();</span><br><span class="line">		<span class="keyword">return</span> s;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="二-Shiro配置"><a href="#二-Shiro配置" class="headerlink" title="二.Shiro配置"></a>二.Shiro配置</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.how2java.tmall.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.how2java.tmall.realm.JPARealm;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.authc.credential.HashedCredentialsMatcher;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.mgt.SecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.LifecycleBeanPostProcessor;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.security.interceptor.AuthorizationAttributeSourceAdvisor;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.spring.web.ShiroFilterFactoryBean;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.web.mgt.DefaultWebSecurityManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Shiro配置文件</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ShiroConfiguration</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> LifecycleBeanPostProcessor <span class="title">getLifecycleBeanPostProcessor</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LifecycleBeanPostProcessor();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 过滤器，实现对请求的拦截和跳转</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ShiroFilterFactoryBean <span class="title">shirFilter</span><span class="params">(SecurityManager securityManager)</span></span>&#123;</span><br><span class="line">        <span class="comment">// 创建 ShiroFilterFactoryBean 对象</span></span><br><span class="line">        ShiroFilterFactoryBean shiroFilterFactoryBean  = <span class="keyword">new</span> ShiroFilterFactoryBean();</span><br><span class="line">        <span class="comment">// 设置SecurityManager</span></span><br><span class="line">        shiroFilterFactoryBean.setSecurityManager(securityManager);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">           这里可以设置URL并为它们配置权限，本项目没有用到</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> shiroFilterFactoryBean;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">// shiro核心组件</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SecurityManager <span class="title">securityManager</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// 创建DefaultWebSecurityManager对象</span></span><br><span class="line">        DefaultWebSecurityManager securityManager =  <span class="keyword">new</span> DefaultWebSecurityManager();</span><br><span class="line">        <span class="comment">// 设置其使用的Realm</span></span><br><span class="line">        securityManager.setRealm(getJPARealm());</span><br><span class="line">        <span class="keyword">return</span> securityManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加载身份认证与授权模块</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JPARealm <span class="title">getJPARealm</span><span class="params">()</span></span>&#123;</span><br><span class="line">        JPARealm myShiroRealm = <span class="keyword">new</span> JPARealm();</span><br><span class="line">        myShiroRealm.setCredentialsMatcher(hashedCredentialsMatcher());</span><br><span class="line">        <span class="keyword">return</span> myShiroRealm;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 指定使用md5加密算法，并进行两次加密</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> HashedCredentialsMatcher <span class="title">hashedCredentialsMatcher</span><span class="params">()</span></span>&#123;</span><br><span class="line">        HashedCredentialsMatcher hashedCredentialsMatcher = <span class="keyword">new</span> HashedCredentialsMatcher();</span><br><span class="line">        hashedCredentialsMatcher.setHashAlgorithmName(<span class="string">&quot;md5&quot;</span>);</span><br><span class="line">        hashedCredentialsMatcher.setHashIterations(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">return</span> hashedCredentialsMatcher;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  开启shiro aop注解支持.</span></span><br><span class="line"><span class="comment">     *  使用代理方式;所以需要开启代码支持;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> securityManager</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthorizationAttributeSourceAdvisor <span class="title">authorizationAttributeSourceAdvisor</span><span class="params">(SecurityManager securityManager)</span></span>&#123;</span><br><span class="line">        AuthorizationAttributeSourceAdvisor authorizationAttributeSourceAdvisor = <span class="keyword">new</span> AuthorizationAttributeSourceAdvisor();</span><br><span class="line">        authorizationAttributeSourceAdvisor.setSecurityManager(securityManager);</span><br><span class="line">        <span class="keyword">return</span> authorizationAttributeSourceAdvisor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h4 id="三-注册接口"><a href="#三-注册接口" class="headerlink" title="三.注册接口"></a>三.注册接口</h4><p>Realm的验证需要对应注册里的加密方法即md5 * 2 + 盐</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注册接口</span></span><br><span class="line"><span class="meta">@PostMapping(&quot;/foreregister&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">register</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span> </span>&#123;</span><br><span class="line">    String name =  user.getName();</span><br><span class="line">    String password = user.getPassword();</span><br><span class="line">    <span class="comment">// 对姓名中的特殊符号进行转义</span></span><br><span class="line">    name = HtmlUtils.htmlEscape(name);</span><br><span class="line">    user.setName(name);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 判断用户名是否存在</span></span><br><span class="line">    <span class="keyword">boolean</span> exist = userService.isExist(name);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(exist)&#123;</span><br><span class="line">        String message =<span class="string">&quot;用户名已经被使用,不能使用&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> Result.fail(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 随机生成盐</span></span><br><span class="line">    String salt = <span class="keyword">new</span> SecureRandomNumberGenerator().nextBytes().toString();</span><br><span class="line">    <span class="keyword">int</span> times = <span class="number">2</span>;</span><br><span class="line">    <span class="comment">// 采用md5加密</span></span><br><span class="line">    String algorithmName = <span class="string">&quot;md5&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// md5 + 盐对用户密码进行加密得到加密密码</span></span><br><span class="line">    <span class="comment">// times = 2，表明进行两次的md5加密</span></span><br><span class="line">    String encodedPassword = <span class="keyword">new</span> SimpleHash(algorithmName, password, salt, times).toString();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将盐和加密密码存入数据库中</span></span><br><span class="line">    user.setSalt(salt);</span><br><span class="line">    user.setPassword(encodedPassword);</span><br><span class="line"></span><br><span class="line">    userService.add(user);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Result.success();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="四-登录接口"><a href="#四-登录接口" class="headerlink" title="四.登录接口"></a>四.登录接口</h4><p>配置好Shiro后，登录验证时可以快速使用啦！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 登录接口</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/forelogin&quot;)</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">login</span><span class="params">(<span class="meta">@RequestBody</span> User userParam, HttpSession session)</span> </span>&#123;</span><br><span class="line">        String name =  userParam.getName();</span><br><span class="line">        name = HtmlUtils.htmlEscape(name);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// shiro认证登录（你是谁？）</span></span><br><span class="line">        <span class="comment">// subject指的是:&quot;当前正在执行的用户的特定的安全视图&quot;</span></span><br><span class="line">        <span class="comment">// 可以把Subject看成是shiro的&quot;User&quot;概念</span></span><br><span class="line">        Subject subject = SecurityUtils.getSubject();</span><br><span class="line">        UsernamePasswordToken token = <span class="keyword">new</span> UsernamePasswordToken(name, userParam.getPassword());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            subject.login(token);</span><br><span class="line">            User user = userService.getByName(name);</span><br><span class="line">            <span class="comment">// 将user存储进seesion中，后续可以随时取出用于验证登录</span></span><br><span class="line">            session.setAttribute(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line">            <span class="keyword">return</span> Result.success();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (AuthenticationException e) &#123;</span><br><span class="line">            String message =<span class="string">&quot;账号密码错误&quot;</span>;</span><br><span class="line">            <span class="keyword">return</span> Result.fail(message);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h3 id="拦截器"><a href="#拦截器" class="headerlink" title="拦截器"></a>拦截器</h3><p>拦截前端某些没有权限的访问，如没有登录权限的用户访问个人信息表，跳转到登录页</p>
<h4 id="一-拦截器"><a href="#一-拦截器" class="headerlink" title="一.拦截器"></a>一.拦截器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.how2java.tmall.interceptor;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpSession;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.SecurityUtils;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.subject.Subject;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.HandlerInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.ModelAndView;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 登录拦截器，用于拦截未登录情况下的访问</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginInterceptor</span> <span class="keyword">implements</span> <span class="title">HandlerInterceptor</span> </span>&#123;</span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    	HttpSession session = httpServletRequest.getSession();</span><br><span class="line">        String contextPath=session.getServletContext().getContextPath();</span><br><span class="line">		<span class="comment">// 需要验证登录的页面</span></span><br><span class="line">        String[] requireAuthPages = <span class="keyword">new</span> String[]&#123;</span><br><span class="line">        		<span class="string">&quot;buy&quot;</span>,</span><br><span class="line">        		<span class="string">&quot;alipay&quot;</span>,</span><br><span class="line">        		<span class="string">&quot;payed&quot;</span>,</span><br><span class="line">        		<span class="string">&quot;cart&quot;</span>,</span><br><span class="line">        		<span class="string">&quot;bought&quot;</span>,</span><br><span class="line">        		<span class="string">&quot;confirmPay&quot;</span>,</span><br><span class="line">        		<span class="string">&quot;orderConfirmed&quot;</span>,</span><br><span class="line">        		<span class="string">&quot;forebuyone&quot;</span>,</span><br><span class="line">        		<span class="string">&quot;forebuy&quot;</span>,</span><br><span class="line">        		<span class="string">&quot;foreaddCart&quot;</span>,</span><br><span class="line">        		<span class="string">&quot;forecart&quot;</span>,</span><br><span class="line">        		<span class="string">&quot;forechangeOrderItem&quot;</span>,</span><br><span class="line">        		<span class="string">&quot;foredeleteOrderItem&quot;</span>,</span><br><span class="line">        		<span class="string">&quot;forecreateOrder&quot;</span>,</span><br><span class="line">        		<span class="string">&quot;forepayed&quot;</span>,</span><br><span class="line">        		<span class="string">&quot;forebought&quot;</span>,</span><br><span class="line">        		<span class="string">&quot;foreconfirmPay&quot;</span>,</span><br><span class="line">        		<span class="string">&quot;foreorderConfirmed&quot;</span>,</span><br><span class="line">        		<span class="string">&quot;foredeleteOrder&quot;</span>,</span><br><span class="line">        		<span class="string">&quot;forereview&quot;</span>,</span><br><span class="line">        		<span class="string">&quot;foredoreview&quot;</span></span><br><span class="line">        		</span><br><span class="line">        &#125;;</span><br><span class="line"> </span><br><span class="line">        <span class="comment">// 获取uri</span></span><br><span class="line">        String uri = httpServletRequest.getRequestURI();</span><br><span class="line"></span><br><span class="line">		<span class="comment">//移除前缀/tmall_springboot</span></span><br><span class="line">        uri = StringUtils.remove(uri, contextPath+<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        String page = uri;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="comment">// 判断链接名，是否以验证登录数组里的开头</span></span><br><span class="line">		<span class="keyword">if</span>(begingWith(page, requireAuthPages))&#123;</span><br><span class="line">			Subject subject = SecurityUtils.getSubject();</span><br><span class="line">			<span class="comment">// 如果是则跳转到login页面</span></span><br><span class="line">			<span class="keyword">if</span>(!subject.isAuthenticated()) &#123;</span><br><span class="line">				httpServletResponse.sendRedirect(<span class="string">&quot;login&quot;</span>);</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;   </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">begingWith</span><span class="params">(String page, String[] requiredAuthPages)</span> </span>&#123;</span><br><span class="line">    	<span class="keyword">boolean</span> result = <span class="keyword">false</span>;</span><br><span class="line">    	<span class="keyword">for</span> (String requiredAuthPage : requiredAuthPages) &#123;</span><br><span class="line">			<span class="keyword">if</span>(StringUtils.startsWith(page, requiredAuthPage)) &#123;</span><br><span class="line">				result = <span class="keyword">true</span>;	</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">    	<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postHandle</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o, ModelAndView modelAndView)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o, Exception e)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>通过实现SpringMCV的HandlerInterceptor来实现拦截器，其中包含3个方法：</p>
<p><strong>public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handle)</strong></p>
<p>该方法将在请求处理之前进行调用。SpringMVC中的Interceptor是链式的调用的，在一个应用中或者说是在一个请求中可以同时存在多个Interceptor 。</p>
<p>每个Interceptor的调用会依据它的声明顺序依次执行，而且最先执行的都是Interceptor中的preHandle方法，所以可以在这个方法中进行一些前置初始化操作或者是对当前请求的一个预处理，也可以在这个方法中进行一些判断来决定请求是否要继续进行下去。</p>
<p>该方法的返回值是布尔值Boolean类型的，当它返回为false 时，表示请求结束，后续的Interceptor和Controller都不会再执行；</p>
<p>当返回值为true时就会继续调用下一个Interceptor的preHandle方法，如果已经是最后一个Interceptor的时候就会是调用当前请求的Controller方法</p>
<p><strong>postHandle(HttpServletRequest request, HttpServletResponse response, Object handle, ModelAndView modelAndView)</strong><br>由preHandle方法的解释我们知道这个方法包括后面要说到的afterCompletion方法都只能是在当前所属的Interceptor的preHandle方法的返回值为true时才能被调用</p>
<p>postHandle方法，顾名思义就是在当前请求进行处理之后，也就是Controller方法调用之后执行，<br>但是它会在DispatcherServlet进行视图返回渲染之前被调用，所以我们可以在这个方法中对Controller处理之后的ModelAndView对象进行操作。</p>
<p>postHandle方法被调用的方向跟preHandle是相反的，也就是说先声明的Interceptor 的postHandle方法反而会后执行，这和Struts2里面的Interceptor 的执行过程有点类型。Struts2 里面的Interceptor 的执行过程也是链式的，只是在Struts2 里面需要手动调用ActionInvocation 的invoke 方法来触发对下一个Interceptor 或者是Action 的调用，然后每一个Interceptor 中在invoke 方法调用之前的内容都是按照声明顺序执行的，而invoke 方法之后的内容就是反向的</p>
<p><strong>afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handle, Exception ex)</strong><br>该方法也是需要当前对应的Interceptor 的preHandle 方法的返回值为true 时才会执行。</p>
<p>顾名思义，该方法将在整个请求结束之后，也就是在DispatcherServlet 渲染了对应的视图之后执行。<br>这个方法的主要作用是用于进行资源清理工作的。</p>
<h4 id="二-拦截器配置"><a href="#二-拦截器配置" class="headerlink" title="二.拦截器配置"></a>二.拦截器配置</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 访问拦截器配置</span></span><br><span class="line"><span class="keyword">package</span> com.how2java.tmall.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.how2java.tmall.interceptor.LoginInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.how2java.tmall.interceptor.OtherInterceptor;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.InterceptorRegistry;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.annotation.WebMvcConfigurerAdapter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="comment">// 拦截器的配置</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">WebMvcConfigurer</span> <span class="keyword">extends</span> <span class="title">WebMvcConfigurerAdapter</span></span>&#123;</span><br><span class="line">	<span class="meta">@Bean</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> LoginInterceptor <span class="title">getLoginIntercepter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">new</span> LoginInterceptor();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h2 id="技术亮点"><a href="#技术亮点" class="headerlink" title="技术亮点"></a>技术亮点</h2><h3 id="循环依赖解决方案"><a href="#循环依赖解决方案" class="headerlink" title="循环依赖解决方案"></a>循环依赖解决方案</h3><h4 id="一-Springboot注解补充"><a href="#一-Springboot注解补充" class="headerlink" title="一.Springboot注解补充"></a>一.Springboot注解补充</h4><p>实体类中，@Transient注解的字段，是不与数据库映射的，可以额外添加到接口的字段即该字段不参与自动关联中的sql查询</p>
<p>这些字段可以用来存储：通过查询数据库得到的列表（不用另外建集合对象存储），需要经过计算的数据（也可以放在数据库），数据状态（也可以放在数据库）</p>
<p>订单表@Transient注解字段，在服务层进行赋值操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 订单项列表</span></span><br><span class="line"><span class="meta">@Transient</span></span><br><span class="line"><span class="keyword">private</span> List&lt;OrderItem&gt; orderItems;</span><br><span class="line"><span class="comment">// 订单总金额</span></span><br><span class="line"><span class="meta">@Transient</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">float</span> total;</span><br><span class="line"><span class="comment">// 订单物品总数量</span></span><br><span class="line"><span class="meta">@Transient</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> totalNumber;</span><br><span class="line"><span class="comment">// 订单状态</span></span><br><span class="line"><span class="meta">@Transient</span></span><br><span class="line"><span class="keyword">private</span> String statusDesc;</span><br></pre></td></tr></table></figure>



<p>使用</p>
<p>@ManyToOne<br>@JoinColumn(name=”pid”)</p>
<p>可以标注关系，就可以使用JPA的findBy等方法如：<code>findByProductOrderByIdDesc</code>    </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 一个产品有多个属性值</span></span><br><span class="line"><span class="meta">@ManyToOne</span></span><br><span class="line"><span class="meta">@JoinColumn(name=&quot;pid&quot;)</span>	</span><br><span class="line"><span class="keyword">private</span> Product product;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 一个属性有多个属性值（属性 + 产品决定一条属性值）</span></span><br><span class="line"><span class="meta">@ManyToOne</span></span><br><span class="line"><span class="meta">@JoinColumn(name=&quot;ptid&quot;)</span></span><br><span class="line"><span class="keyword">private</span> Property property;</span><br></pre></td></tr></table></figure>



<h4 id="二-数据库设计：多对多关系"><a href="#二-数据库设计：多对多关系" class="headerlink" title="二.数据库设计：多对多关系"></a>二.数据库设计：多对多关系</h4><p>在实际应用中，多对多关系会分解为两个一对多的关系</p>
<p>属性值由产品和属性共同决定</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 一个产品，有多个属性值（不同属性，同一产品）</span></span><br><span class="line"><span class="meta">@ManyToOne</span></span><br><span class="line"><span class="meta">@JoinColumn(name=&quot;pid&quot;)</span> </span><br><span class="line"><span class="keyword">private</span> Product product;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 一个属性有多个属性值（不同产品，同一属性）</span></span><br><span class="line"><span class="meta">@ManyToOne</span></span><br><span class="line"><span class="meta">@JoinColumn(name=&quot;ptid&quot;)</span></span><br><span class="line"><span class="keyword">private</span> Property property;</span><br></pre></td></tr></table></figure>



<p>订单项由订单，用户，产品共同决定</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 一个产品可以有多个订单项（不同用户/不同订单，同一产品）</span></span><br><span class="line"><span class="meta">@ManyToOne</span></span><br><span class="line"><span class="meta">@JoinColumn(name=&quot;pid&quot;)</span>	</span><br><span class="line"><span class="keyword">private</span> Product product;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 一个订单可以有多个订单项（不同产品/不同用户，同一订单）</span></span><br><span class="line"><span class="meta">@ManyToOne</span></span><br><span class="line"><span class="meta">@JoinColumn(name=&quot;oid&quot;)</span></span><br><span class="line"><span class="keyword">private</span> Order order;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 一个用户可以有多个订单项（不同产品/不同订单，同一用户）</span></span><br><span class="line"><span class="meta">@ManyToOne</span></span><br><span class="line"><span class="meta">@JoinColumn(name=&quot;uid&quot;)</span></span><br><span class="line"><span class="keyword">private</span> User user;</span><br></pre></td></tr></table></figure>

<p>在review类中的内对象如：prouct，user由于一对多的关联，在数据库中映射为pid，uid字段）</p>
<p>所以说JPA是一个ORM框架，对象和数据库无缝衔接</p>
<h4 id="三-循环依赖的解决"><a href="#三-循环依赖的解决" class="headerlink" title="三.循环依赖的解决"></a>三.循环依赖的解决</h4><p>在SpringBoot + JPA的架构中，容易出现循环依赖问题，一般会出现在一对多的场景下，总结来说是一对多实体中都要引用对方来维持OnetoMany的关系，所以极容易出现循环依赖:(</p>
<h5 id="1-经典场景"><a href="#1-经典场景" class="headerlink" title="1.经典场景"></a>1.经典场景</h5><p>订单项中引用订单，以构成多对一关系</p>
<p>可以使用订单项查找其属于的订单</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 一个订单可以有多个订单项（不同产品/不同用户，同一订单）</span></span><br><span class="line"><span class="meta">@ManyToOne</span></span><br><span class="line"><span class="meta">@JoinColumn(name=&quot;oid&quot;)</span></span><br><span class="line"><span class="keyword">private</span> Order order;</span><br></pre></td></tr></table></figure>



<p>订单中引用订单项存储在集合中，用来存储从数据库查询来的结构（往往是因为要利用这些字段进行计算）</p>
<p>可以使用订单id查找订单项列表</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 订单项列表</span></span><br><span class="line"><span class="meta">@Transient</span></span><br><span class="line"><span class="keyword">private</span> List&lt;OrderItem&gt; orderItems;</span><br><span class="line"><span class="comment">// 订单总金额</span></span><br><span class="line"><span class="meta">@Transient</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">float</span> total;</span><br><span class="line"><span class="comment">// 订单物品总数量</span></span><br><span class="line"><span class="meta">@Transient</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> totalNumber;</span><br></pre></td></tr></table></figure>



<p>这样的结构就是循环依赖，导致数据重复加载，因为orderItems要调用方法填充，所以会为空（一般情况下会栈溢出）最终造成的数据是：Order含有orderItems，orderItems含有Order，Order的orderItem列表为空，所以这里的Order重复了一次</p>
<h5 id="2-方案一：-JsonBackReference注解"><a href="#2-方案一：-JsonBackReference注解" class="headerlink" title="2.方案一：@JsonBackReference注解"></a>2.方案一：@JsonBackReference注解</h5><p>JsonBackReference注解用在一（一对多的一）的一方，可以阻止其被序列化，前提是对应的接口不需要调用到它，而只是需要用它来查询</p>
<p>如：一个产品有多张图片，我们不需要在图片列表接口使用到产品信息，而只是需要用产品id查询其图片</p>
<p><strong>产品类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transient</span></span><br><span class="line"><span class="comment">// 产品首图</span></span><br><span class="line"><span class="keyword">private</span> ProductImage firstProductImage;</span><br><span class="line"><span class="meta">@Transient</span></span><br><span class="line"><span class="keyword">private</span> List&lt;ProductImage&gt; productSingleImages;</span><br><span class="line"><span class="meta">@Transient</span></span><br><span class="line"><span class="keyword">private</span> List&lt;ProductImage&gt; productDetailImages;</span><br></pre></td></tr></table></figure>



<p><strong>产品图片类</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ManyToOne</span></span><br><span class="line"><span class="meta">@JoinColumn(name=&quot;pid&quot;)</span></span><br><span class="line"><span class="meta">@JsonBackReference</span></span><br><span class="line"><span class="keyword">private</span> Product product;</span><br></pre></td></tr></table></figure>



<p><strong>缺点</strong></p>
<ul>
<li>关系是双向的，使用了JsonBackReference，就无法使用根据图片找到其属于的产品的方法，只能单方向查询即根据产品查找到其图片列表</li>
<li>JsonBackReference标记的字段与Redis的整合会有冲突</li>
</ul>
<h5 id="3-方案二：及时清除法"><a href="#3-方案二：及时清除法" class="headerlink" title="3.方案二：及时清除法"></a>3.方案二：及时清除法</h5><p>在服务层定义清除方法，在控制层调用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Orderitem中有Order字段，标注多对一关系</span></span><br><span class="line"><span class="comment">// Order中有Orderitem列表，用于存储订单项列表</span></span><br><span class="line"><span class="comment">// Order中有Orderitem列表，而Orderitem中又有Order字段，产生无穷的递归</span></span><br><span class="line"><span class="comment">// 所以这里需要设置Orderitem的Order设为空</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeOrderFromOrderItem</span><span class="params">(List &lt;Order&gt; orders)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (Order order : orders) &#123;</span><br><span class="line">		removeOrderFromOrderItem(order);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeOrderFromOrderItem</span><span class="params">(Order order)</span> </span>&#123;</span><br><span class="line">	List&lt;OrderItem&gt; orderItems= order.getOrderItems();</span><br><span class="line">	<span class="keyword">for</span> (OrderItem orderItem : orderItems) &#123;</span><br><span class="line">		orderItem.setOrder(<span class="keyword">null</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 填充Order的orderItem列表</span></span><br><span class="line">orderItemService.fill(page.getContent());</span><br><span class="line"><span class="comment">// 清除orderItem中的Order字段</span></span><br><span class="line">orderService.removeOrderFromOrderItem(page.getContent());</span><br></pre></td></tr></table></figure>



<h5 id="4-方案三：延迟加载"><a href="#4-方案三：延迟加载" class="headerlink" title="4.方案三：延迟加载"></a>4.方案三：延迟加载</h5><p>关于延迟加载：<a target="_blank" rel="noopener" href="https://www.baeldung.com/hibernate-lazy-eager-loading">延迟加载介绍</a></p>
<p>使用<code>FetchType.LAZY</code>的方法，在不适用关系属性时，就不会自动获取，而一旦触发使用就会自动获取其属性 问题是<code>Jackson</code>对<code>Hibernate</code>的<code>LazyFetch</code>并不默认支持，需要一些额外支持</p>
<p>使用jackson-datatype-hibernate5插件使Jackson支持hibernate的lazyFetch</p>
<p>pom.xml中添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.fasterxml.jackson.datatype<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jackson-datatype-hibernate5<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.10.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<p>增加配置类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span> </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HibernateModuleConfig</span> </span>&#123;</span><br><span class="line">       <span class="meta">@Bean</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> MappingJackson2HttpMessageConverter <span class="title">mappingJackson2HttpMessageConverter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">              MappingJackson2HttpMessageConverter jsonConverter = <span class="keyword">new</span> MappingJackson2HttpMessageConverter();</span><br><span class="line">              ObjectMapper objectMapper = jsonConverter.getObjectMapper();</span><br><span class="line">              objectMapper.registerModule(<span class="keyword">new</span> Hibernate5Module());</span><br><span class="line">              <span class="keyword">return</span> jsonConverter;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>实体上增加主键Id识别信息，防止出现循环引用 所有关系都为Lazy，直观上不会出现循环引用，但是当你通过一对多查询而多对一存在引用时仍会出现循环引用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@JsonIdentityInfo(</span></span><br><span class="line"><span class="meta">      generator = ObjectIdGenerators.PropertyGenerator.class,</span></span><br><span class="line"><span class="meta">      property = &quot;id&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CardModifyLog</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>





<h5 id="5-其他方案"><a href="#5-其他方案" class="headerlink" title="5.其他方案"></a>5.其他方案</h5><ul>
<li>创建DTO，类似的思路还有创建接口投影或者实体视图，见<a target="_blank" rel="noopener" href="https://www.baeldung.com/spring-data-jpa-named-entity-graphs">Spring Data JPA和命名实体图</a>、<a target="_blank" rel="noopener" href="https://docs.spring.io/spring-data/jpa/docs/2.2.2.RELEASE/reference/html/#projections">Spring data jpa 投影</a>。 问题在于需要根据情况创建多个视图或者多个投影（DTO），由于各个实体间关系的复杂程度，不建议用此方式</li>
<li>使用<code>@Transient</code>注解使所有的关系不被存储即不与数据库的字段对应，同时存在于实体中，每次使用时，自己手动查询set 也许是一种好办法，但是失去了关系的约束，可能得不偿失</li>
</ul>
<h3 id="缓存AOP拦截失效问题"><a href="#缓存AOP拦截失效问题" class="headerlink" title="缓存AOP拦截失效问题"></a>缓存AOP拦截失效问题</h3><h4 id="一-问题出现原因"><a href="#一-问题出现原因" class="headerlink" title="一.问题出现原因"></a>一.问题出现原因</h4><p>Spring只有在代理对象之间进行调用时，可以触发切面逻辑才可以使用事务，在同一个class中，方法B调用方法A，调用的是原对象的方法，而不通过代理对象就无法使用事务,如果方法B有事务只会使用方法B的事务，不会去管方法A的事务所以一个类中方法调用当前类的其他拥有事务的方法时这个被调用方法事务会失效</p>
<p>一个类中方法调用当前类的其他拥有事务的方法时这个被调用方法事务会失效。在默认的代理模式下，只有目标方法由外部调用，才能被 Spring 的事务拦截器拦截</p>
<p>同理使用spring cache模块的@Cacheable等注解 在同一个class中互相调用是无法走缓存的 因为这样无法访问到spring容器中的那个代理对象</p>
<p>因为Springboot的缓存机制是通过切面编程aop来实现，从fill方法中调用listByCategory即内部调用，aop是拦截不到的，自然不会走缓存</p>
<h4 id="二-问题解决方案"><a href="#二-问题解决方案" class="headerlink" title="二.问题解决方案"></a>二.问题解决方案</h4><p>可以使用 AspectJ 取代 Spring AOP 代理来解决，也可以使用工具类诱发aop</p>
<p>fill方法调用诱发工具类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 填充分类中的产品集合</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fill</span><span class="params">(Category category)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 通过SpringContextUtil调用listByCategory上的缓存方法</span></span><br><span class="line">    <span class="comment">// 即 @Cacheable(key=&quot;&#x27;products-cid-&#x27;+ #p0.id&quot;)</span></span><br><span class="line">    <span class="comment">// 这样在方法内部的查询也能够使用缓存</span></span><br><span class="line">    ProductService productService = SpringContextUtil.getBean(ProductService.class);</span><br><span class="line">    List&lt;Product&gt; products = productService.listByCategory(category);</span><br><span class="line">    productImageService.setFirstProdutImages(products);</span><br><span class="line">    category.setProducts(products);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>SpringContextUtil工具类诱发aop</p>
<p>我们需要在代码中需要动态获取其它bean，我们可以通过实现ApplicationContextAware接口来实现</p>
<p>ApplicationContextAware可以对当前bean传入对应的Spring上下文</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.how2java.tmall.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContext;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.ApplicationContextAware;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取spring容器，以访问容器中定义的其他bean</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringContextUtil</span> <span class="keyword">implements</span> <span class="title">ApplicationContextAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Spring应用上下文环境</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ApplicationContext applicationContext;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 实现ApplicationContextAware接口的回调方法，设置上下文环境</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setApplicationContext</span><span class="params">(ApplicationContext applicationContext)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        SpringContextUtil.applicationContext = applicationContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ApplicationContext <span class="title">getApplicationContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> applicationContext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取对象 这里重写了bean方法，起主要作用</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> name</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span>  Object</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> BeansException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">getBean</span><span class="params">(String beanId)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> applicationContext.getBean(beanId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="分页动态数组开发"><a href="#分页动态数组开发" class="headerlink" title="分页动态数组开发"></a>分页动态数组开发</h3><h4 id="一-简单分页方法"><a href="#一-简单分页方法" class="headerlink" title="一.简单分页方法"></a>一.简单分页方法</h4><h5 id="1-Service层实现简单分页方法"><a href="#1-Service层实现简单分页方法" class="headerlink" title="1.Service层实现简单分页方法"></a>1.Service层实现简单分页方法</h5><p>这里使用JPA提供的Pageable类型对列表进行分页</p>
<p>Pageable是从0开始计算页数的，所以这里需要<code>pageNum - 1</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Page&lt;Category&gt; <span class="title">getpage</span><span class="params">(<span class="keyword">int</span> pageNum, <span class="keyword">int</span> pageLimit)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    Pageable pageable = <span class="keyword">new</span> PageRequest(pageNum - <span class="number">1</span> , pageLimit);</span><br><span class="line">    <span class="keyword">return</span> categoryDAO.findAll(pageable);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="2-Controller层调用分页方法"><a href="#2-Controller层调用分页方法" class="headerlink" title="2.Controller层调用分页方法"></a>2.Controller层调用分页方法</h5><p>通过@RequestParam设置从前台get方法发来的page和size信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/catepage&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Page&lt;Category&gt; <span class="title">pageList</span><span class="params">(<span class="meta">@RequestParam(value = &quot;page&quot;, defaultValue = &quot;1&quot;)</span> <span class="keyword">int</span> page ,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="meta">@RequestParam(value = &quot;size&quot;, defaultValue = &quot;5&quot;)</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> categoryService.getpage(page, size);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="3-测试结果"><a href="#3-测试结果" class="headerlink" title="3.测试结果"></a>3.测试结果</h5><p>访问请求链接：<a target="_blank" rel="noopener" href="http://localhost:8080/shopping_system/catepage?page=2&amp;size=5">http://localhost:8080/shopping_system/catepage?page=2&amp;size=5</a></p>
<img src="https://raw.githubusercontent.com/Autovy/Image/master/img/202203060908527.png" alt="image-20211215173655433" style="zoom:80%;">



<h4 id="二-分页动态数组组类"><a href="#二-分页动态数组组类" class="headerlink" title="二.分页动态数组组类"></a>二.分页动态数组组类</h4><h5 id="1-分页功能进阶封装"><a href="#1-分页功能进阶封装" class="headerlink" title="1.分页功能进阶封装"></a>1.分页功能进阶封装</h5><p>JPA提供的分页类可以返回分割后的列表内容和分类信息如<strong>总共数据数（totalElements），总共分割的页面（totalPages）与当前访问的页面（number）</strong>，但是这些数据不能方便提供一个方便的接口让前端实现<strong>部分分页节点展示</strong>和<strong>分页节点遍历</strong></p>
<p><img src="https://raw.githubusercontent.com/Autovy/Image/master/img/202203060908268.png" alt="image-20220228201059144"></p>
<p>当前是第8页，前面要显示3个，后面要显示3个，总共7条分页点，Pageable默认就不提供了，即Pageable无法实现根据当前选择页调整接口返回的数据，而只能硬性分页</p>
<p>所以我们需要做了一个 PageNavigator， 首先对 Page 类进行了封装，然后在构造方法里提供了一个 navigatePages 参数作为区间分页节点数</p>
<p>在构造方法里，还调用了 calcNavigatepageNums， 就是用来计算这个数值，并返回到一个int 数组变量 navigatepageNums ，方便前端遍历展示，而这个数组的大小为navigatePages</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PageNavigator</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 引用Page类</span></span><br><span class="line">    Page&lt;T&gt; pageFromJPA;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> totalPages;</span><br><span class="line">    <span class="keyword">int</span> number;</span><br><span class="line">    <span class="keyword">long</span> totalElements;</span><br><span class="line">    <span class="keyword">int</span> size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 单页数据数</span></span><br><span class="line">    <span class="keyword">int</span> numberOfElements;</span><br><span class="line">    <span class="comment">// 分页数据</span></span><br><span class="line">    List&lt;T&gt; contents;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 是否为首尾判断</span></span><br><span class="line">    <span class="keyword">boolean</span> first;</span><br><span class="line">    <span class="keyword">boolean</span> last;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 是否有数据</span></span><br><span class="line">    <span class="keyword">boolean</span> isHasContent;</span><br><span class="line">    <span class="comment">// 是否有前驱</span></span><br><span class="line">    <span class="keyword">boolean</span> isHasPrevious;</span><br><span class="line">    <span class="comment">// 是否有后续</span></span><br><span class="line">    <span class="keyword">boolean</span> isHasNext;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 规定区间分页节点数</span></span><br><span class="line">    <span class="keyword">int</span> navigatePages;</span><br><span class="line">    <span class="comment">// 规定区间分页节点列表</span></span><br><span class="line">    <span class="keyword">int</span>[] navigatepageNums;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 无参构造函数</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PageNavigator</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造规定分页区间大小的分页函数</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">PageNavigator</span><span class="params">(Page&lt;T&gt; pageFromJPA, <span class="keyword">int</span> navigatePages)</span></span>&#123;</span><br><span class="line">        <span class="comment">// 引用Page里面的成员变量</span></span><br><span class="line">        <span class="keyword">this</span>.pageFromJPA = pageFromJPA;</span><br><span class="line">        <span class="keyword">this</span>.navigatePages = navigatePages;</span><br><span class="line"></span><br><span class="line">        totalPages = pageFromJPA.getTotalPages();</span><br><span class="line">        number = pageFromJPA.getNumber();</span><br><span class="line">        totalElements = pageFromJPA.getTotalElements();</span><br><span class="line">        size = pageFromJPA.getNumberOfElements();</span><br><span class="line">        contents = pageFromJPA.getContent();</span><br><span class="line">        isHasContent = pageFromJPA.hasContent();</span><br><span class="line">        first = pageFromJPA.isFirst();</span><br><span class="line">        last = pageFromJPA.isLast();</span><br><span class="line">        isHasNext = pageFromJPA.hasNext();</span><br><span class="line">        isHasPrevious = pageFromJPA.hasPrevious();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算出分页节点列表</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">calcNavigatepageNums</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] navigatepageNums;</span><br><span class="line">        <span class="comment">// 总页数</span></span><br><span class="line">        <span class="keyword">int</span> totalPages = getTotalPages();</span><br><span class="line">        <span class="comment">// 当前页</span></span><br><span class="line">        <span class="keyword">int</span> num = getNumber();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 总页数小于区间分页节点数</span></span><br><span class="line">        <span class="keyword">if</span>(totalPages &lt;= navigatePages)&#123;</span><br><span class="line">            navigatepageNums = <span class="keyword">new</span> <span class="keyword">int</span>[totalPages];</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; totalPages; i++)&#123;</span><br><span class="line">                navigatepageNums[i] = i + <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            navigatepageNums = <span class="keyword">new</span> <span class="keyword">int</span>[ navigatePages];</span><br><span class="line">            <span class="comment">// 计算区间列表首尾索引</span></span><br><span class="line">            <span class="keyword">int</span> startNum = num - navigatePages / <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">int</span> endNum = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span>(navigatePages % <span class="number">2</span> == <span class="number">0</span>)&#123;</span><br><span class="line">                endNum = num + navigatePages / <span class="number">2</span> - <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                endNum = num + navigatePages / <span class="number">2</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 首navigatePages页</span></span><br><span class="line">            <span class="keyword">if</span>(startNum &lt; <span class="number">0</span>)&#123;</span><br><span class="line">                startNum = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; navigatePages; i++)&#123;</span><br><span class="line">                    navigatepageNums[i] = startNum++;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 尾navigatePages页</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(startNum &gt; navigatePages)&#123;</span><br><span class="line">                endNum = totalPages;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> i = navigatePages - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)&#123;</span><br><span class="line">                    navigatepageNums[i] = endNum--;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 中间navigatePages页</span></span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; navigatePages; i++)&#123;</span><br><span class="line">                    navigatepageNums[i] = startNum++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.navigatepageNums = navigatepageNums;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 成员变量对应的Getter与Setter</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getTotalPages</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> totalPages;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTotalPages</span><span class="params">(<span class="keyword">int</span> totalPages)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.totalPages = totalPages;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getNumber</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> number;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNumber</span><span class="params">(<span class="keyword">int</span> number)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.number = number;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getTotalElements</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> totalElements;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setTotalElements</span><span class="params">(<span class="keyword">long</span> totalElements)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.totalElements = totalElements;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSize</span><span class="params">(<span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.size = size;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getNumberOfElements</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> numberOfElements;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNumberOfElements</span><span class="params">(<span class="keyword">int</span> numberOfElements)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.numberOfElements = numberOfElements;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;T&gt; <span class="title">getContents</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> contents;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContents</span><span class="params">(List&lt;T&gt; contents)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.contents = contents;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isFirst</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> first;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFirst</span><span class="params">(<span class="keyword">boolean</span> first)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.first = first;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isLast</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> last;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setLast</span><span class="params">(<span class="keyword">boolean</span> last)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.last = last;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isHasContent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> isHasContent;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHasContent</span><span class="params">(<span class="keyword">boolean</span> hasContent)</span> </span>&#123;</span><br><span class="line">        isHasContent = hasContent;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isHasPrevious</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> isHasPrevious;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHasPrevious</span><span class="params">(<span class="keyword">boolean</span> hasPrevious)</span> </span>&#123;</span><br><span class="line">        isHasPrevious = hasPrevious;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isHasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> isHasNext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setHasNext</span><span class="params">(<span class="keyword">boolean</span> hasNext)</span> </span>&#123;</span><br><span class="line">        isHasNext = hasNext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getNavigatePages</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> navigatePages;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNavigatePages</span><span class="params">(<span class="keyword">int</span> navigatePages)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.navigatePages = navigatePages;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[] getNavigatepageNums() &#123;</span><br><span class="line">        <span class="keyword">return</span> navigatepageNums;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNavigatepageNums</span><span class="params">(<span class="keyword">int</span>[] navigatepageNums)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.navigatepageNums = navigatepageNums;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>除了上面的写法外，如果不需要修改方法名，完全可以在继承Page类的基础上进行拓展</p>
<h5 id="2-Service层实现进阶分页方法"><a href="#2-Service层实现进阶分页方法" class="headerlink" title="2.Service层实现进阶分页方法"></a>2.Service层实现进阶分页方法</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> PageNavigator&lt;Category&gt; <span class="title">getpage</span><span class="params">(<span class="keyword">int</span> page, <span class="keyword">int</span> size, <span class="keyword">int</span> navigatePages)</span></span>&#123;</span><br><span class="line">    Sort sort = <span class="keyword">new</span> Sort(Sort.Direction.DESC, <span class="string">&quot;id&quot;</span>);</span><br><span class="line">    Pageable pageable = <span class="keyword">new</span> PageRequest(page, size, sort);</span><br><span class="line">    Page pageFrom = categoryDAO.findAll(pageable);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> PageNavigator&lt;&gt;(pageFrom, navigatePages);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="3-Controller层调用进阶分页方法"><a href="#3-Controller层调用进阶分页方法" class="headerlink" title="3.Controller层调用进阶分页方法"></a>3.Controller层调用进阶分页方法</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/catepage&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PageNavigator&lt;Category&gt; <span class="title">pageList</span><span class="params">(<span class="meta">@RequestParam(value = &quot;page&quot;, defaultValue = &quot;1&quot;)</span> <span class="keyword">int</span> page,</span></span></span><br><span class="line"><span class="function"><span class="params">                               <span class="meta">@RequestParam(value = &quot;size&quot;, defaultValue = &quot;5&quot;)</span> <span class="keyword">int</span> size)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">			</span><br><span class="line">        <span class="comment">// 接口初始页调整为从1开始</span></span><br><span class="line">        page = page &lt; <span class="number">1</span> ? <span class="number">1</span> : page;</span><br><span class="line">        PageNavigator&lt;Category&gt; list = categoryService.getpage(page - <span class="number">1</span>, size, <span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h5 id="4-测试结果"><a href="#4-测试结果" class="headerlink" title="4.测试结果"></a>4.测试结果</h5><p>访问地址：<a target="_blank" rel="noopener" href="http://localhost:8080/tmall_springboot/categories?start=3&amp;size=2">http://localhost:8080/tmall_springboot/categories?start=3&amp;size=2</a></p>
<p>可以看到最终实现了提供一个存储5个页面索引的数组</p>
<p><img src="https://raw.githubusercontent.com/Autovy/Image/master/img/202202282106562.png" alt="image-20220228210601487"></p>
<h4 id="三-分页方法比较"><a href="#三-分页方法比较" class="headerlink" title="三.分页方法比较"></a>三.分页方法比较</h4><p>JPA提供的分页类——Page可以满足各种分页需求，大部分时候用它就足够了，但是Pageable无法实现根据当前选择页调整接口返回的数据，而只能硬性分页即 <code>页数（totalPage） =  数据数（totalElements） / 页大小（size）</code> </p>
<p>表现在前端所有的分页都在一组分页栏中，如果想部分显示分页栏就需要前端去定制分页分组方法</p>
<img src="https://raw.githubusercontent.com/Autovy/Image/master/img/202203060908527.png" alt="image-20211215173655433" style="zoom:80%;">



<p>但是如果前端有需求让后端根据当前选择页，以当前页为中点返回n个页面为一组的索引供前端调用</p>
<p>这时候我们就要对Page类进行封装，构造一个分页组类，在构造方法中提供一个navigatePages参数（分页组大小），并提供calNavigateNums方法根据当前页计算出分到同一组的页面索引并存储到数组navigatepageNums中供前端遍历展示</p>
<p>表现在前端可以通过接口获得当前页同一组分页的索引方便遍历</p>
<p><img src="https://raw.githubusercontent.com/Autovy/Image/master/img/202202282106562.png" alt="image-20220228210601487"></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/ifme/p/12005026.html">Spring Data Elasticsearch基本使用</a></p>
<p><a target="_blank" rel="noopener" href="https://onblogs.net/2019/05/29/史上最全面的Elasticsearch使用指南/">史上最全面的Elasticsearch使用指南</a></p>
<p><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844904002400813070">Spring data jpa中实体关系解决方案</a></p>
<p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/a2f98f6d6fbd">Spring Data JPA 使用详解</a></p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/aUqH_lFxohMWPW4xOpPTcA">Redis实用指南</a></p>
<p><a target="_blank" rel="noopener" href="https://www.baeldung.com/hibernate-lazy-eager-loading">延迟加载介绍</a><br>-lazy-eager-loading)</p>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Autovy
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://autovy.github.io/2021/10/20/Java/Java-%E7%89%A9%E8%B5%84%E7%94%B3%E8%AF%B7%E7%B3%BB%E7%BB%9F%E5%BC%80%E5%8F%91%E6%80%BB%E7%BB%93/" title="Java|物资申请系统开发总结">https://autovy.github.io/2021/10/20/Java/Java-物资申请系统开发总结/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fa fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Java/" rel="tag"><i class="fa fa-tag"></i> Java</a>
              <a href="/tags/SpringBoot/" rel="tag"><i class="fa fa-tag"></i> SpringBoot</a>
              <a href="/tags/%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/" rel="tag"><i class="fa fa-tag"></i> 项目实战</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/10/17/DevPrinciple/HTTP%E4%B8%8EHTTPS/" rel="prev" title="开发原理|HTTP与HTTPS">
      <i class="fa fa-chevron-left"></i> 开发原理|HTTP与HTTPS
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/10/25/Java/Java-%E9%A1%B9%E7%9B%AE%E6%B7%B1%E5%BA%A6%E8%A7%A3%E6%9E%90/" rel="next" title="Java|项目深度解析">
      Java|项目深度解析 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>



  
  
  

  </div>


          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E6%9E%B6%E6%9E%84"><span class="nav-text">数据库架构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BB%93%E6%9E%84%E5%9B%BE"><span class="nav-text">数据库结构图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BB%E8%A6%81%E6%95%B0%E6%8D%AE%E8%A1%A8%E4%BF%A1%E6%81%AF"><span class="nav-text">主要数据表信息</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%80-%E7%89%A9%E8%B5%84%E7%94%B3%E8%AF%B7%E8%A1%A8"><span class="nav-text">一.物资申请表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%8C-%E7%89%A9%E8%B5%84%E7%94%B3%E8%AF%B7%E8%AF%A6%E6%83%85%E8%A1%A8"><span class="nav-text">二.物资申请详情表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%89-%E7%89%A9%E8%B5%84%E8%A1%A8"><span class="nav-text">三.物资表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9B%9B-%E7%94%A8%E6%88%B7%E8%A1%A8"><span class="nav-text">四.用户表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%94-%E6%9D%83%E9%99%90%E8%A1%A8"><span class="nav-text">五.权限表</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84"><span class="nav-text">系统架构</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%80%E6%9C%AF%E6%9E%B6%E6%9E%84"><span class="nav-text">技术架构</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%80-%E5%89%8D%E7%AB%AF"><span class="nav-text">一.前端</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%8C-%E5%90%8E%E7%AB%AF"><span class="nav-text">二.后端</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%89-%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="nav-text">三.数据库</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E4%BE%9D%E8%B5%96%E5%87%86%E5%A4%87"><span class="nav-text">相关依赖准备</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%80%E5%8F%91%E5%86%85%E5%AE%B9"><span class="nav-text">开发内容</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#MySQL%E4%BC%98%E5%8C%96%E8%BF%87%E7%A8%8B"><span class="nav-text">MySQL优化过程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%80-T-SQL%E8%84%9A%E6%9C%AC%E5%88%86%E8%A1%A8%E4%BC%98%E5%8C%96"><span class="nav-text">一.T-SQL脚本分表优化</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-%E7%9B%B8%E5%85%B3%E8%A1%A8%E7%9A%84%E7%BB%93%E6%9E%84"><span class="nav-text">1.相关表的结构</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-%E4%BC%98%E5%8C%96%E6%80%9D%E8%B7%AF%EF%BC%9A%E7%89%A9%E8%B5%84%E7%94%B3%E8%AF%B7%E8%A1%A8%E5%88%86%E8%A1%A8"><span class="nav-text">2.优化思路：物资申请表分表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-%E4%BC%98%E5%8C%96%E6%93%8D%E4%BD%9C%EF%BC%9A%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E8%84%9A%E6%9C%AC"><span class="nav-text">3.优化操作：存储过程脚本</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-%E4%BC%98%E5%8C%96%E7%BB%93%E6%9E%9C"><span class="nav-text">4.优化结果</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%8C-%E7%B4%A2%E5%BC%95%E4%BC%98%E5%8C%96%E6%9F%A5%E8%AF%A2"><span class="nav-text">二.索引优化查询</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-%E7%9B%B8%E5%85%B3%E8%A1%A8%E7%BB%93%E6%9E%84"><span class="nav-text">1.相关表结构</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-%E4%BC%98%E5%8C%96%E6%80%9D%E8%B7%AF%EF%BC%9A%E6%B7%BB%E5%8A%A0%E7%B4%A2%E5%BC%95"><span class="nav-text">2.优化思路：添加索引</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-%E4%BC%98%E5%8C%96%E6%93%8D%E4%BD%9C"><span class="nav-text">3.优化操作</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-%E4%BC%98%E5%8C%96%E7%BB%93%E6%9E%9C-1"><span class="nav-text">4.优化结果</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Elasticsearch%E6%90%9C%E7%B4%A2"><span class="nav-text">Elasticsearch搜索</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%80-ES%E9%85%8D%E7%BD%AE"><span class="nav-text">一.ES配置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-ES%E5%8F%AF%E8%A7%86%E5%8C%96"><span class="nav-text">1.ES可视化</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-%E9%85%8D%E7%BD%AEES"><span class="nav-text">2.配置ES</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%8C-ES%E5%BC%80%E5%8F%91%E6%B5%81%E7%A8%8B"><span class="nav-text">二.ES开发流程</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-ES%E6%B3%A8%E8%A7%A3%E5%AE%9E%E4%BD%93%E7%B1%BB"><span class="nav-text">1.ES注解实体类</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-esDAO%E7%9A%84%E5%88%9B%E5%BB%BA"><span class="nav-text">2.esDAO的创建</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-Application%E5%BC%95%E5%85%A5ES"><span class="nav-text">3.Application引入ES</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-%E6%9C%8D%E5%8A%A1%E5%B1%82%E5%90%8C%E6%AD%A5ES"><span class="nav-text">4.服务层同步ES</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-%E6%9C%8D%E5%8A%A1%E5%B1%82%E6%9F%A5%E8%AF%A2ES"><span class="nav-text">5.服务层查询ES</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Redis%E7%BC%93%E5%AD%98"><span class="nav-text">Redis缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%80-Redis%E5%8F%AF%E8%A7%86%E5%8C%96%E5%B7%A5%E5%85%B7"><span class="nav-text">一.Redis可视化工具</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%8C-Redis%E9%85%8D%E7%BD%AE"><span class="nav-text">二.Redis配置</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-Redis%E9%85%8D%E7%BD%AE%E7%B1%BB"><span class="nav-text">1.Redis配置类</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-Redis%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-text">2.Redis配置文件</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%89-%E7%BC%93%E5%AD%98%E5%90%AF%E7%94%A8%E4%B8%8E%E6%A3%80%E6%B5%8B"><span class="nav-text">三.缓存启用与检测</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-%E7%BC%93%E5%AD%98%E7%9A%84%E5%90%AF%E7%94%A8"><span class="nav-text">1.缓存的启用</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-%E6%9C%8D%E5%8A%A1%E5%BC%80%E5%90%AF%E6%A3%80%E6%B5%8B"><span class="nav-text">2.服务开启检测</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9B%9B-%E7%BC%93%E5%AD%98%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">四.缓存的使用</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-%E6%9C%89%E5%BA%8F%E9%9B%86%E5%90%88%E7%AE%A1%E7%90%86"><span class="nav-text">1.有序集合管理</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2%E6%9F%A5%E8%AF%A2%E6%8F%92%E5%85%A5%E7%BC%93%E5%AD%98"><span class="nav-text">2查询插入缓存</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-%E6%9B%B4%E6%96%B0%E5%88%A0%E9%99%A4%E7%BC%93%E5%AD%98"><span class="nav-text">3.更新删除缓存</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Shiro%E7%99%BB%E5%BD%95%E9%AA%8C%E8%AF%81"><span class="nav-text">Shiro登录验证</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%80-JPARealm%E9%AA%8C%E8%AF%81%E6%8E%88%E6%9D%83%E5%99%A8"><span class="nav-text">一.JPARealm验证授权器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%8C-Shiro%E9%85%8D%E7%BD%AE"><span class="nav-text">二.Shiro配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%89-%E6%B3%A8%E5%86%8C%E6%8E%A5%E5%8F%A3"><span class="nav-text">三.注册接口</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%9B%9B-%E7%99%BB%E5%BD%95%E6%8E%A5%E5%8F%A3"><span class="nav-text">四.登录接口</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="nav-text">拦截器</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%80-%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="nav-text">一.拦截器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%8C-%E6%8B%A6%E6%88%AA%E5%99%A8%E9%85%8D%E7%BD%AE"><span class="nav-text">二.拦截器配置</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8A%80%E6%9C%AF%E4%BA%AE%E7%82%B9"><span class="nav-text">技术亮点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-text">循环依赖解决方案</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%80-Springboot%E6%B3%A8%E8%A7%A3%E8%A1%A5%E5%85%85"><span class="nav-text">一.Springboot注解补充</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%8C-%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1%EF%BC%9A%E5%A4%9A%E5%AF%B9%E5%A4%9A%E5%85%B3%E7%B3%BB"><span class="nav-text">二.数据库设计：多对多关系</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%89-%E5%BE%AA%E7%8E%AF%E4%BE%9D%E8%B5%96%E7%9A%84%E8%A7%A3%E5%86%B3"><span class="nav-text">三.循环依赖的解决</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-%E7%BB%8F%E5%85%B8%E5%9C%BA%E6%99%AF"><span class="nav-text">1.经典场景</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-%E6%96%B9%E6%A1%88%E4%B8%80%EF%BC%9A-JsonBackReference%E6%B3%A8%E8%A7%A3"><span class="nav-text">2.方案一：@JsonBackReference注解</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-%E6%96%B9%E6%A1%88%E4%BA%8C%EF%BC%9A%E5%8F%8A%E6%97%B6%E6%B8%85%E9%99%A4%E6%B3%95"><span class="nav-text">3.方案二：及时清除法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-%E6%96%B9%E6%A1%88%E4%B8%89%EF%BC%9A%E5%BB%B6%E8%BF%9F%E5%8A%A0%E8%BD%BD"><span class="nav-text">4.方案三：延迟加载</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#5-%E5%85%B6%E4%BB%96%E6%96%B9%E6%A1%88"><span class="nav-text">5.其他方案</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%93%E5%AD%98AOP%E6%8B%A6%E6%88%AA%E5%A4%B1%E6%95%88%E9%97%AE%E9%A2%98"><span class="nav-text">缓存AOP拦截失效问题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%80-%E9%97%AE%E9%A2%98%E5%87%BA%E7%8E%B0%E5%8E%9F%E5%9B%A0"><span class="nav-text">一.问题出现原因</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%8C-%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-text">二.问题解决方案</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E9%A1%B5%E5%8A%A8%E6%80%81%E6%95%B0%E7%BB%84%E5%BC%80%E5%8F%91"><span class="nav-text">分页动态数组开发</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%80-%E7%AE%80%E5%8D%95%E5%88%86%E9%A1%B5%E6%96%B9%E6%B3%95"><span class="nav-text">一.简单分页方法</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-Service%E5%B1%82%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E5%88%86%E9%A1%B5%E6%96%B9%E6%B3%95"><span class="nav-text">1.Service层实现简单分页方法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-Controller%E5%B1%82%E8%B0%83%E7%94%A8%E5%88%86%E9%A1%B5%E6%96%B9%E6%B3%95"><span class="nav-text">2.Controller层调用分页方法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C"><span class="nav-text">3.测试结果</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BA%8C-%E5%88%86%E9%A1%B5%E5%8A%A8%E6%80%81%E6%95%B0%E7%BB%84%E7%BB%84%E7%B1%BB"><span class="nav-text">二.分页动态数组组类</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-%E5%88%86%E9%A1%B5%E5%8A%9F%E8%83%BD%E8%BF%9B%E9%98%B6%E5%B0%81%E8%A3%85"><span class="nav-text">1.分页功能进阶封装</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-Service%E5%B1%82%E5%AE%9E%E7%8E%B0%E8%BF%9B%E9%98%B6%E5%88%86%E9%A1%B5%E6%96%B9%E6%B3%95"><span class="nav-text">2.Service层实现进阶分页方法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#3-Controller%E5%B1%82%E8%B0%83%E7%94%A8%E8%BF%9B%E9%98%B6%E5%88%86%E9%A1%B5%E6%96%B9%E6%B3%95"><span class="nav-text">3.Controller层调用进阶分页方法</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#4-%E6%B5%8B%E8%AF%95%E7%BB%93%E6%9E%9C"><span class="nav-text">4.测试结果</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%B8%89-%E5%88%86%E9%A1%B5%E6%96%B9%E6%B3%95%E6%AF%94%E8%BE%83"><span class="nav-text">三.分页方法比较</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">参考资料</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
<a href="/">  <img class="site-author-image" itemprop="image" alt="Autovy"
      src="/images/2.png">  </a>
  <p class="site-author-name" itemprop="name">Autovy</p>
  <div class="site-description" itemprop="description">新时代农民工的数字农田</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">54</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">72</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2020 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-code"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Autovy</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">738k</span>
</div>

<!-- 在网页底部添加网站运行时间 -->
<span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span>
<script>
    var now = new Date();
    function createtime() {
        var grt= new Date("01/01/2020 00:00:00");//此处修改你的建站时间或者网站上线时间
        now.setTime(now.getTime()+250);
        days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
        hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
        if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
        mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
        seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
        snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
        document.getElementById("timeDate").innerHTML = "Run for "+dnum+" Days ";
        document.getElementById("times").innerHTML = hnum + " Hours " + mnum + " m " + snum + " s";
    }
setInterval("createtime()",250);
</script>


    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv" title="总访客量">
    本站已有
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    位访客
    <i class="fa fa-user"></i>
    </span>
  
<span> | </span>

  
    <span class="site-pv" title="总访问量">
   
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    次阅读
    <i class="fa fa-eye"></i>
    </span>
  
</div>







      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'RVJRabsBhxWXvhMcG8CH5wbc-gzGzoHsz',
      appKey     : 'JSGLk7guOagDPMFN9wbASkEh',
      placeholder: "说点什么吧",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
  <script src="/js/bloom.js" type="text/javascript"></script>